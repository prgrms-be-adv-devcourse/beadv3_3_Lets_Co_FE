name: Build and release docker image # 워크플로우의 이름입니다.

on: # 워크플로우가 실행되는 트리거 조건을 정의합니다.
  workflow_call: # 다른 워크플로우에서 '호출(call)'될 때만 실행되도록 설정합니다(재사용 가능).
    inputs: # 호출할 때 넘겨받아야 할 파라미터(변수)들을 정의합니다.
      service-name: # 서비스 이름 (예: gateway-service)
        required: true # 필수 입력값입니다.
        type: string # 문자열 타입입니다.
      service-dir: # 서비스 디렉토리 경로 (예: Gateway)
        required: true
        type: string
      file-name: # Dockerfile의 이름 (보통 Dockerfile)
        required: true
        type: string
      tag-prefix: # [추가] 태그 접두사 입력 받기
        required: false
        type: string
        default: "v"
    secrets: # 호출할 때 넘겨받아야 할 보안 값(Secrets)들을 정의합니다.
      DOCKER_USERNAME: # Docker Hub 아이디
        required: true
      DOCKER_PASSWORD: # Docker Hub 비밀번호/토큰
        required: true
      VITE_API_BASE_URL: # 생성할 application.yml의 내용
        required: true
    outputs: # 이 워크플로우가 끝난 후 반환할 값을 정의합니다.
      tag_name: # 생성된 태그 이름(버전)을 반환합니다.
        value: ${{ jobs.tagging.outputs.tag_name }}

env: # 워크플로우 전체에서 사용할 환경 변수입니다.
  REGISTRY: docker.io # 사용할 레지스트리 주소 (Docker Hub)

jobs: # 실제 수행할 작업들을 정의합니다.
  tagging: # 첫 번째 작업: 버전 태그 생성
    name: 태깅 및 릴리즈 # UI에 표시될 작업 이름
    runs-on: ubuntu-latest # 최신 우분투 환경에서 실행
    outputs: # 다음 작업(build-image)에서 사용할 수 있도록 출력값을 설정
      tag_name: ${{ steps.tag_version.outputs.new_tag }} # 새로 생성된 태그
      changelog: ${{ steps.tag_version.outputs.changelog }} # 변경 내역

    steps: # 작업의 세부 단계
      - uses: actions/checkout@v5 # 현재 저장소의 코드를 내려받습니다.

      - name: versioning and tagging # 버전 태그를 생성하는 단계
        id: tag_version # 이 단계의 ID (출력값 참조용)
        uses: mathieudutour/github-tag-action@v6.2 # 태그 생성용 액션 사용
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }} # 깃허브 권한 토큰 (자동 생성됨)
          tag_prefix: ${{ inputs.tag-prefix }} # [추가] 접두사 적용

      - name: releasing # 깃허브 릴리즈 페이지에 릴리즈 노트를 생성하는 단계
        uses: ncipollo/release-action@v1 # 릴리즈 생성용 액션 사용
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }} # 위에서 만든 태그 사용
          name: ${{ steps.tag_version.outputs.new_tag }} # 릴리즈 이름도 태그와 동일하게
          body: ${{ steps.tag_version.outputs.changelog }} # 변경 로그 내용을 본문에 작성

  build-image: # 두 번째 작업: 도커 이미지 빌드
    name: 도커 이미지 빌드
    runs-on: ubuntu-latest
    needs: tagging # 'tagging' 작업이 성공해야만 실행됨

    permissions: # 이 작업에 필요한 권한 설정
      contents: read # 코드 읽기 권한
      packages: read # 패키지 읽기 권한
      attestations: write # 증명서 쓰기 권한
      id-token: write # ID 토큰 쓰기 권한

    steps:
      - name: Check out Repository # 코드를 다시 내려받습니다(새 작업이므로 환경이 초기화됨).
        uses: actions/checkout@v5

      # [중요] Secrets에 저장된 설정 내용을 실제 파일로 만드는 과정
      - name: Create application.yml
        run: | # 여러 줄의 명령어를 실행
          cat << 'EOF' > ./.env.production
          ${{ secrets.VITE_API_BASE_URL }}
          EOF

      # - name: Setup Java 21 # 자바 환경 설정
      #   uses: actions/setup-java@v5
      #   with:
      #     distribution: temurin # Eclipse Temurin 배포판 사용
      #     java-version: 21 # 자바 21 버전
      #     cache: gradle # Gradle 빌드 캐시 활성화 (속도 향상)

      # - name: Gradle build # Gradle로 프로젝트 빌드
      #   working-directory: ${{ inputs.service-dir }} # 해당 서비스 폴더에서 실행
      #   # 실행 권한 부여 후 빌드 수행 (테스트는 제외 -x test)
      #   run: chmod +x gradlew && ./gradlew clean build -x test --no-daemon

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Sign in to Docker Hub # 도커 허브 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata # 도커 이미지에 붙일 태그와 라벨 생성
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ inputs.service-name }}
          tags: |
            type=raw,value=${{ needs.tagging.outputs.tag_name }}

      - name: Build and Push Image # 이미지를 빌드하고 푸시
        uses: docker/build-push-action@v5
        with:
          context: ./${{ inputs.service-dir }} # 빌드 컨텍스트 (해당 서비스 폴더)
          file: ./${{ inputs.service-dir }}/${{ inputs.file-name }} # Dockerfile 위치
          push: true # 빌드 후 레지스트리로 푸시함
          tags: ${{ steps.meta.outputs.tags }} # 위에서 만든 태그들 적용
          labels: ${{ steps.meta.outputs.labels }} # 라벨 적용
          cache-from: type=gha # 깃허브 액션 캐시 사용 (빌드 속도 향상)
          cache-to: type=gha,mode=max # 캐시 저장
