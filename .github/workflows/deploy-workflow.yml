name: Deploy and Rolling Update

on:
  workflow_call:
    inputs:
      service-name: # 배포할 서비스 이름
        required: true
        type: string
      image-tag: # 배포할 이미지의 태그 (버전)
        required: true
        type: string
    secrets:
      DOCKER_USERNAME: # 이미지 주소 조합용
        required: true

env:
  REGISTRY: docker.io

jobs:
  deploy:
    name: 쿠버네티스 배포
    runs-on: self-hosted # [중요] 사용자의 서버(Self-hosted Runner)에서 직접 실행됩니다.

    steps:
      - name: Checkout repository # 배포 스크립트 등을 위해 코드 체크아웃
        uses: actions/checkout@v5

      - name: Update deployment image # 쿠버네티스 이미지 업데이트 명령
        run: |
          # kubectl set image 명령어로 실행 중인 컨테이너의 이미지를 새 버전으로 교체
          kubectl set image deployment.apps/${{ inputs.service-name }} \
            ${{ inputs.service-name }}=${{ secrets.DOCKER_USERNAME }}/${{ inputs.service-name }}:${{ inputs.image-tag }}

      - name: Wait for rollout # 배포가 완료될 때까지 대기
        run: |
          # 롤아웃 상태를 모니터링하여 성공/실패 여부 확인
          kubectl rollout status deployment.apps/${{ inputs.service-name }}

      - name: Verify deployment # 배포된 파드 상태 확인
        run: |
          # 해당 앱 라벨을 가진 파드 목록 조회
          kubectl get pods -l app=${{ inputs.service-name }}
